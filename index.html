<!DOCTYPE html>
<html>
<head>
  <title>TM + MQTT Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h2>Teachable Machine + MQTT</h2>
  <input type="text" id="broker" value="wss://broker.hivemq.com:8884/mqtt">
  <input type="text" id="topic" value="tm/prediction">
  <button onclick="connectMQTT()">Connect MQTT</button>
  <button onclick="startCamera()">Start Camera</button>
  <div id="webcam-container"></div>
  <div id="label-container"></div>
  <div id="mqtt-status"></div>
  <div id="debug"></div>

<script>
let model, webcam, client, topic;

async function startCamera() {
  model = await tmImage.load("https://teachablemachine.withgoogle.com/models/Z_7bvhRna/model.json", 
                             "https://teachablemachine.withgoogle.com/models/Z_7bvhRna/metadata.json");
  webcam = new tmImage.Webcam(224,224,false);
  await webcam.setup({facingMode:'environment'});
  webcam.webcam.srcObject = webcam.webcam.srcObject || webcam.webcam.captureStream();
  await webcam.play();
  document.getElementById("webcam-container").appendChild(webcam.canvas);
  requestAnimationFrame(loop);
}

function connectMQTT() {
  const broker = document.getElementById("broker").value;
  topic = document.getElementById("topic").value;
  const clientId = "tm_client_" + Math.random().toString(16).substr(2,8);
  client = mqtt.connect(broker, { clientId, clean:true, connectTimeout:4000, reconnectPeriod:1000, protocolVersion:4 });

  client.on('connect', () => document.getElementById("mqtt-status").innerText="MQTT Connected");
  client.on('offline', () => document.getElementById("mqtt-status").innerText="MQTT Offline");
  client.on('error', err => document.getElementById("mqtt-status").innerText="MQTT Error: "+err);
}

async function loop() {
  webcam.update();
  const prediction = await model.predict(webcam.canvas);
  let payload = {};
  prediction.forEach(p => payload[p.className] = p.probability.toFixed(2));
  document.getElementById("label-container").innerText = JSON.stringify(payload, null, 2);

  if(client && client.connected) client.publish(topic, JSON.stringify(payload));
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
