<!DOCTYPE html>
<html>
<head>
  <title>Teachable Machine + MQTT (Cool UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ‡πÇ‡∏´‡∏•‡∏î TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <!-- ‡πÇ‡∏´‡∏•‡∏î Teachable Machine Image -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <!-- ‡πÇ‡∏´‡∏•‡∏î MQTT -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; text-align:center; padding:20px; }
    h2 { color: #0f0; }
    #controls button { 
      padding: 10px 20px; margin: 5px; border: none; border-radius: 10px;
      background: linear-gradient(45deg,#0f0,#0ff); color:#111; font-weight:bold;
      cursor: pointer; transition: transform 0.2s;
    }
    #controls button:hover { transform: scale(1.05); }
    #webcam-container { margin: 15px auto; }
    video, canvas { border-radius: 15px; box-shadow: 0 0 15px #0f0; max-width: 100%; }
    #label-container { margin-top:10px; font-size:1.1em; text-align:left; display:inline-block; background:#222; padding:15px; border-radius:10px; box-shadow:0 0 10px #0f0; }
    .label { margin:5px 0; padding:8px; border-radius:6px; background:#333; }
    .high { background:#0f05; color:#0f0; font-weight:bold; }
    #mqtt-status { font-weight:bold; margin:10px; font-size:1.2em; }
    .connected { color:lime; }
    .disconnected { color:red; }
    .sending { color:orange; }
    #debug { font-family: monospace; white-space: pre-wrap; max-width:600px; margin:auto; text-align:left; background:#111; color:#aaa; padding:10px; border-radius:10px; }
  </style>
</head>
<body>
  <h2>üçÄ Teachable Machine + MQTT Dashboard üçÄ</h2>

  <!-- MQTT UI -->
  <div id="controls">
    <input id="broker-input" value="wss://broker.hivemq.com:8884/mqtt" placeholder="Broker URL">
    <input id="topic-input" value="tm/prediction" placeholder="Topic">
    <button onclick="connectMQTT()">Connect MQTT</button>
    <button onclick="disconnectMQTT()">Disconnect MQTT</button>
    <div id="mqtt-status" class="disconnected">MQTT: Disconnected</div>
  </div>

  <!-- Camera controls -->
  <div id="controls">
    <button onclick="startCamera('environment')">üì∑ Back Camera</button>
    <button onclick="startCamera('user')">ü§≥ Front Camera</button>
    <button onclick="stopCamera()">üõë Stop Camera</button>
  </div>

  <div id="webcam-container"></div>
  <div id="label-container"></div>
  <div id="debug"></div>

<script>
let model, webcam, client, topic;
const debug = document.getElementById("debug");
const mqttStatus = document.getElementById("mqtt-status");

function logDebug(msg){
  const time = new Date().toLocaleTimeString();
  debug.innerText += `[${time}] ${msg}\n`;
  debug.scrollTop = debug.scrollHeight;
}

// MQTT Connect
function connectMQTT(){
  const broker = document.getElementById("broker-input").value;
  topic = document.getElementById("topic-input").value;
  if(!broker||!topic){ alert("Enter Broker and Topic"); return; }
  const clientId = "tm_client_"+Math.random().toString(16).substr(2,8);

  client = mqtt.connect(broker, { clientId, clean:true, connectTimeout:4000, reconnectPeriod:1000 });

  client.on('connect', ()=> { mqttStatus.innerText="MQTT: Connected"; mqttStatus.className="connected"; logDebug("MQTT Connected"); });
  client.on('offline', ()=> { mqttStatus.innerText="MQTT: Offline"; mqttStatus.className="disconnected"; logDebug("MQTT Offline"); });
  client.on('error', err=> { mqttStatus.innerText="MQTT: Error"; mqttStatus.className="disconnected"; logDebug("MQTT Error: "+JSON.stringify(err)); });
}
function disconnectMQTT(){
  if(client){ client.end(); client=null; mqttStatus.innerText="MQTT: Disconnected"; mqttStatus.className="disconnected"; }
}

// Camera + TM
async function startCamera(facingMode){
  const URL = "https://teachablemachine.withgoogle.com/models/Z_7bvhRna/"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô model ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  model = await tmImage.load(URL+"model.json", URL+"metadata.json");
  webcam = new tmImage.Webcam(224,224,false);
  try{
    await webcam.setup({facingMode});
    await webcam.play();
    document.getElementById("webcam-container").innerHTML = "";
    document.getElementById("webcam-container").appendChild(webcam.canvas);
    requestAnimationFrame(loop);
    logDebug("Camera started: "+facingMode);
  }catch(e){
    alert("Cannot access camera: "+e.message);
    logDebug("Camera error: "+e.message);
  }
}

function stopCamera(){
  if(webcam){ 
    webcam.stop(); 
    document.getElementById("webcam-container").innerHTML='';
    document.getElementById("label-container").innerHTML='';
    logDebug("Camera stopped");
  }
}

async function loop(){
  webcam.update();
  const prediction = await model.predict(webcam.canvas);
  const labelContainer = document.getElementById("label-container");
  labelContainer.innerHTML = "";

  let sendPayload = null;
  prediction.forEach(p=>{
    const prob = p.probability.toFixed(2);
    const div = document.createElement("div");
    div.className="label"+(p.probability>=0.9?" high":"");
    div.innerText = `${p.className}: ${prob}`;
    labelContainer.appendChild(div);

    if(p.probability>=0.9){ sendPayload = {class:p.className, probability:prob}; }
  });

  if(sendPayload && client && client.connected){
    mqttStatus.innerText="MQTT: Sending..."; mqttStatus.className="sending";
    client.publish(topic, JSON.stringify(sendPayload), {}, ()=>{
      mqttStatus.innerText="MQTT: Connected"; mqttStatus.className="connected";
      logDebug("Sent MQTT: "+JSON.stringify(sendPayload));
    });
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
