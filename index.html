<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TM + MQTT Dashboard Modern</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f7fa; display:flex; flex-direction:column; align-items:center; }
header { background:#4A90E2; color:white; padding:15px; width:100%; text-align:center; font-size:1.3rem; }
.container { display:flex; gap:20px; margin:20px; max-width:1000px; width:100%; }
.card { background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:15px; flex:1; }
#webcam-container canvas { width:100%; border-radius:12px; background:black; }
.class-box { display:flex; justify-content:space-between; margin:6px 0; padding:8px; border-radius:8px; background:#f0f0f0; font-size:0.95rem; }
.class-box.active { background:#d1eaff; font-weight:bold; }
.progress { height:6px; background:#ddd; border-radius:4px; overflow:hidden; margin-top:4px; }
.progress-bar { height:100%; background:#4A90E2; }
.mqtt-box { margin-top:10px; font-size:0.9rem; }
.status { font-weight:bold; }
.connected { color:green; }
.disconnected { color:red; }
.sending { color:orange; }
button { padding:8px 14px; border:none; border-radius:8px; cursor:pointer; background:#4A90E2; color:white; font-size:0.9rem; margin:4px; }
button:hover { background:#357ABD; }
input { padding:6px; border-radius:6px; border:1px solid #ccc; margin:4px 0; width:100%; }
#last-sent { margin-top:8px; font-weight:bold; color:#007BFF; }
</style>
</head>
<body>

<header> TM + MQTT Dashboard</header>

<div class="container">
  <div class="card" style="flex:2;">
    <h3>Camera</h3>
    <div id="webcam-container"></div>
    <div>
      <button onclick="startCamera('environment')">Back Camera</button>
      <button onclick="startCamera('user')">Front Camera</button>
      <button onclick="stopCamera()">Stop Camera</button>
    </div>
    <h3>Prediction</h3>
    <div id="label-container"></div>
  </div>

  <div class="card" style="flex:1;">
    <h3>MQTT Settings</h3>
    <label>Broker:</label>
    <input id="broker-input" value="wss://broker.hivemq.com:8884/mqtt">
    <label>Topic:</label>
    <input id="topic-input" value="Tiny/test">
    <div>
      <button onclick="connectMQTT()">Connect</button>
      <button onclick="disconnectMQTT()">Disconnect</button>
    </div>
    <div class="mqtt-box">
      <div>Broker: <span id="mqtt-broker">-</span></div>
      <div>Topic: <span id="mqtt-topic">-</span></div>
      <div>Status: <span id="mqtt-status" class="status disconnected">Disconnected</span></div>
      <div>Messages Sent: <span id="mqtt-count">0</span></div>
      <div>Last Sent: <span id="last-sent">-</span></div>
    </div>
  </div>
</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/Z_7bvhRna/";
let model, webcam, maxPredictions;
let client;
let msgCount = 0;
const THRESHOLD = 0.95;
const IGNORE_CLASS = "None"; 
let lastSentTime = 0;        
const COOLDOWN = 5000;       

async function startCamera(facingMode){
  if(!model){
    model = await tmImage.load(MODEL_URL+"model.json", MODEL_URL+"metadata.json");
    maxPredictions = model.getTotalClasses();
  }
  if(webcam) stopCamera();
  webcam = new tmImage.Webcam(300,300,true);
  await webcam.setup({facingMode});
  await webcam.play();
  document.getElementById("webcam-container").innerHTML="";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
  window.requestAnimationFrame(loop);
}

function stopCamera(){
  if(webcam){
    let stream = webcam.webcam.srcObject;
    stream.getTracks().forEach(track=>track.stop());
    document.getElementById("webcam-container").innerHTML="";
    document.getElementById("label-container").innerHTML="";
    webcam = null;
  }
}

async function loop(){
  if(!webcam) return;
  webcam.update();
  const prediction = await model.predict(webcam.canvas);
  renderUI(prediction);

  const topPrediction = prediction.reduce((a,b)=>a.probability>b.probability?a:b);
  const now = Date.now();

  if(topPrediction.className !== IGNORE_CLASS &&
     topPrediction.probability >= THRESHOLD &&
     client && client.connected &&
     now - lastSentTime >= COOLDOWN) {

    sendMQTT(topPrediction.className);
    lastSentTime = now;
  }
  requestAnimationFrame(loop);
}

function renderUI(prediction){
  const container = document.getElementById("label-container");
  container.innerHTML="";
  const topPrediction = prediction.reduce((a,b)=>a.probability>b.probability?a:b);
  prediction.forEach(p=>{
    const div = document.createElement("div");
    div.className="class-box";
    if(topPrediction.className === p.className) div.classList.add("active");
    div.innerHTML=`<span>${p.className}</span><span>${(p.probability*100).toFixed(1)}%</span>
      <div class="progress"><div class="progress-bar" style="width:${(p.probability*100).toFixed(1)}%"></div></div>`;
    container.appendChild(div);
  });
}

// MQTT Functions
function connectMQTT(){
  const broker = document.getElementById("broker-input").value;
  const topic = document.getElementById("topic-input").value;
  if(!broker||!topic){ alert("Enter Broker and Topic"); return; }
  client = mqtt.connect(broker);

  document.getElementById("mqtt-broker").innerText = broker;
  document.getElementById("mqtt-topic").innerText = topic;

  client.on("connect", ()=>{
    document.getElementById("mqtt-status").innerText="Connected";
    document.getElementById("mqtt-status").className="connected";
  });
  client.on("error", err=>{
    document.getElementById("mqtt-status").innerText="Error";
    document.getElementById("mqtt-status").className="disconnected";
    console.error(err);
  });
  client.on("close", ()=>{
    document.getElementById("mqtt-status").innerText="Disconnected";
    document.getElementById("mqtt-status").className="disconnected";
  });
}

function disconnectMQTT(){
  if(client){ client.end(); client=null;
    document.getElementById("mqtt-status").innerText="Disconnected";
    document.getElementById("mqtt-status").className="disconnected";
    document.getElementById("last-sent").innerText = "-";
  }
}

function sendMQTT(className){
  if(client && client.connected){
    document.getElementById("mqtt-status").innerText="Sending...";
    document.getElementById("mqtt-status").className="sending";
    client.publish(document.getElementById("mqtt-topic").innerText, className, {}, ()=>{
      document.getElementById("mqtt-status").innerText="Connected";
      document.getElementById("mqtt-status").className="connected";
      msgCount++;
      document.getElementById("mqtt-count").innerText = msgCount;
      document.getElementById("last-sent").innerText = className;
    });
  }
}
</script>
</body>
</html>

